---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/ui/Hero.astro';
import Section from '../components/ui/Section.astro';
import Card from '../components/ui/Card.astro';
import Badge from '../components/ui/Badge.astro';
import Button from '../components/ui/Button.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

// Import cover images for optimized loading
import hdcfFlexicapCover from '../assets/images/reports/hdfc-flexicap/cover.png';

// Map article slugs to their cover images
const coverImages: Record<string, ImageMetadata> = {
  'hdfc-flexicap-performance': hdcfFlexicapCover,
  // Add more mappings as articles are migrated
};

// Fetch and sort reports using Content Collections
const allReports = await getCollection('reports');
// Filter out template files (starting with underscore)
const sortedReports = allReports
  .filter(report => !report.id.startsWith('_'))
  .sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

const getCategoryColor = (category) => {
  if (category === 'Fund Analysis') return 'bg-navy/10 text-navy';
  if (category === 'Category Comparison') return 'bg-gold/10 text-gold-dark';
  if (category === 'Methodology') return 'bg-gray-100 text-gray-500';
  return 'bg-blue-50 text-blue-600';
};
---

<Layout title="Analysis Reports - Fund Investigator" description="In-depth mutual fund analysis reports.">
  <Hero size="sm" class="-mb-8 md:-mb-12">
    <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-display-xl font-bold text-navy mb-6 leading-tight break-words">Investigation Reports</h1>
    <p class="text-base sm:text-lg md:text-xl text-secondary-gray max-w-2xl mx-auto font-light leading-relaxed">In-depth research on mutual fund performance, risk patterns, and portfolio trends.</p>
  </Hero>

  <Section background="white" spacing="md" maxWidth="xl">
    <div class="flex flex-wrap gap-3 mb-12 justify-center" id="filter-container">
      <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all bg-navy text-white hover:opacity-90 active" data-filter="all">All Reports</button>
      <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200" data-filter="Fund Analysis">Fund Analysis</button>
      <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200" data-filter="Category Comparison">Comparisons</button>
      <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200" data-filter="Methodology">Methodology</button>
    </div>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="reports-grid">
      {sortedReports.map((report) => {
        // Use report.slug for cover image lookup
        const articleSlug = report.slug;
        const optimizedCover = coverImages[articleSlug];

        return (
        <div class="report-item" data-category={report.data.category}>
          <a href={`/reports/${report.slug}`} class="block h-full">
            <Card padding="none" class="group h-full hover:shadow-lg transition-all duration-300">
              {optimizedCover ? (
                <div class="h-48 overflow-hidden bg-gray-100">
                  <Image
                    src={optimizedCover}
                    alt={report.data.coverImageAlt || report.data.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                    widths={[400, 600, 800]}
                    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 400px"
                  />
                </div>
              ) : report.data.coverImage ? (
                <div class="h-48 overflow-hidden bg-gray-100">
                  <img
                    src={report.data.coverImage}
                    alt={report.data.coverImageAlt || report.data.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  />
                </div>
              ) : (
                <div class={`h-48 flex items-center justify-center transition-colors ${getCategoryColor(report.data.category)}`}>
                  <svg class="w-16 h-16 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                </div>
              )}
              <div class="p-6">
                <div class="mb-3"><Badge>{report.data.category}</Badge></div>
                <h2 class="text-heading-md font-bold text-navy mb-3 leading-snug group-hover:text-gold transition-colors">{report.data.title}</h2>
                <p class="text-body-sm text-secondary-gray mb-4 leading-relaxed line-clamp-3">{report.data.description}</p>
                <div class="flex items-center justify-between text-xs text-gray-500 mb-4">
                  <time>{new Date(report.data.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</time>
                  <span>{report.data.readTime}</span>
                </div>
                <div class="flex flex-wrap gap-2">
                  {report.data.tags && report.data.tags.map((tag) => (<Badge variant="secondary" size="sm">{tag}</Badge>))}
                </div>
              </div>
            </Card>
          </a>
        </div>
        );
      })}
    </div>
    
    <div class="mt-16 text-center">
        </div>
  </Section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.filter-btn');
    const items = document.querySelectorAll('.report-item');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => { b.classList.remove('bg-navy', 'text-white'); b.classList.add('bg-gray-100', 'text-gray-600'); });
        btn.classList.remove('bg-gray-100', 'text-gray-600'); btn.classList.add('bg-navy', 'text-white');
        const filterValue = btn.getAttribute('data-filter');
        items.forEach(item => {
          if (filterValue === 'all' || item.getAttribute('data-category') === filterValue) {
            item.classList.remove('hidden'); item.classList.add('block', 'animate-fade-in');
          } else {
            item.classList.add('hidden'); item.classList.remove('block', 'animate-fade-in');
          }
        });
      });
    });
  });
</script>